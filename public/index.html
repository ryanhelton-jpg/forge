<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forge</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #ff6b35;
    }

    header h1 span { opacity: 0.5; font-weight: 400; }

    .header-actions { display: flex; gap: 0.5rem; }

    .btn {
      background: transparent;
      border: 1px solid #333;
      color: #888;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .btn:hover { border-color: #555; color: #ccc; }
    .btn.active { border-color: #ff6b35; color: #ff6b35; }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 85%;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: #1a3a5c;
      color: #b8d4e8;
    }

    .message.assistant {
      align-self: flex-start;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
    }

    .message.thinking-msg {
      align-self: flex-start;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid #2a3f5f;
      font-size: 0.9rem;
      color: #8892b0;
      position: relative;
      padding-left: 2.5rem;
    }

    .message.thinking-msg::before {
      content: 'üß†';
      position: absolute;
      left: 0.75rem;
      top: 1rem;
    }

    .thinking-label {
      font-size: 0.75rem;
      color: #5a6a8a;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .message.wait {
      opacity: 0.6;
      font-style: italic;
    }

    .message.error {
      background: #3a1a1a;
      border-color: #5a2a2a;
      color: #e88;
    }

    #input-area {
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid #222;
      display: flex;
      gap: 0.75rem;
    }

    #message-input {
      flex: 1;
      background: #111;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 0.875rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
    }

    #message-input:focus { border-color: #ff6b35; }

    #send-btn {
      background: #ff6b35;
      border: none;
      color: #fff;
      padding: 0 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s;
    }

    #send-btn:hover { background: #ff8555; }
    #send-btn:disabled { background: #444; cursor: not-allowed; }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #555;
      gap: 0.5rem;
    }

    .empty-state .logo { font-size: 3rem; margin-bottom: 1rem; }

    .sidebar {
      position: fixed;
      right: -350px;
      top: 0;
      bottom: 0;
      width: 350px;
      background: #111;
      border-left: 1px solid #222;
      transition: right 0.3s;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open { right: 0; }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h2 { font-size: 1rem; color: #ff6b35; }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid #222;
    }

    .sidebar-tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-size: 0.85rem;
      border-bottom: 2px solid transparent;
    }

    .sidebar-tab.active {
      color: #ff6b35;
      border-bottom-color: #ff6b35;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .item-card {
      padding: 0.75rem;
      background: #1a1a1a;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .item-card .label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 0.25rem;
    }

    .item-card .delete {
      float: right;
      color: #666;
      cursor: pointer;
    }

    .item-card .delete:hover { color: #e88; }

    .trait-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .trait {
      background: #2a2a4a;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      color: #a0a0ff;
    }

    .status-bar {
      padding: 0.5rem 1rem;
      border-top: 1px solid #222;
      font-size: 0.75rem;
      color: #555;
      display: flex;
      justify-content: space-between;
    }

    .feature-badges {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: #222;
      color: #888;
    }
  </style>
</head>
<body>
  <header>
    <h1>‚öíÔ∏è Forge <span>v0.3</span></h1>
    <div class="header-actions">
      <button class="btn" onclick="toggleSidebar()">Config</button>
      <button class="btn" onclick="newChat()">New Chat</button>
    </div>
  </header>

  <div id="chat">
    <div class="empty-state">
      <div class="logo">‚öíÔ∏è</div>
      <div>Self-evolving AI agent</div>
      <div class="feature-badges">
        <span class="badge">üß¨ Self-Evolution</span>
        <span class="badge">üß† Thinking</span>
        <span class="badge">üîß Tool Creation</span>
      </div>
    </div>
  </div>

  <div id="input-area">
    <textarea id="message-input" placeholder="Type a message..." rows="1" onkeydown="handleKeydown(event)"></textarea>
    <button id="send-btn" onclick="sendMessage()">Send</button>
  </div>

  <div class="status-bar">
    <span id="session-status">New session</span>
    <span id="persona-status">Loading...</span>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>‚öôÔ∏è Configuration</h2>
      <button class="btn" onclick="toggleSidebar()">‚úï</button>
    </div>
    <div class="sidebar-tabs">
      <div class="sidebar-tab active" onclick="switchTab('persona')">Persona</div>
      <div class="sidebar-tab" onclick="switchTab('memory')">Memory</div>
      <div class="sidebar-tab" onclick="switchTab('tools')">Tools</div>
    </div>
    <div class="sidebar-content">
      <div id="persona-panel" class="tab-panel active">
        <div id="persona-info">Loading...</div>
      </div>
      <div id="memory-panel" class="tab-panel">
        <div id="memory-list">Loading...</div>
      </div>
      <div id="tools-panel" class="tab-panel">
        <div id="tools-list">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    
    let isWaiting = false;
    let sessionId = localStorage.getItem('forge_session') || null;
    let authToken = localStorage.getItem('forge_token') || null;

    // Check/prompt for token
    function checkAuth() {
      if (!authToken) {
        authToken = prompt('Enter Forge access token:');
        if (authToken) {
          localStorage.setItem('forge_token', authToken);
        }
      }
    }
    checkAuth();

    function updateSessionStatus() {
      document.getElementById('session-status').textContent = 
        sessionId ? `Session: ${sessionId.slice(0, 8)}...` : 'New session';
    }

    function addMessage(content, role, className = '') {
      const emptyState = chatEl.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      const div = document.createElement('div');
      div.className = `message ${role} ${className}`.trim();
      div.textContent = content;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }

    function addThinking(content) {
      const emptyState = chatEl.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      const div = document.createElement('div');
      div.className = 'message thinking-msg';
      div.innerHTML = `<div class="thinking-label">Thinking</div>${escapeHtml(content)}`;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }

    async function sendMessage() {
      const message = inputEl.value.trim();
      if (!message || isWaiting) return;

      addMessage(message, 'user');
      inputEl.value = '';
      inputEl.style.height = 'auto';

      isWaiting = true;
      sendBtn.disabled = true;
      const waitEl = addMessage('thinking...', 'assistant', 'wait');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ message, sessionId }),
        });

        const data = await res.json();
        waitEl.remove();

        if (data.error) {
          addMessage(`Error: ${data.error}`, 'assistant', 'error');
        } else {
          // Show thinking if present
          if (data.thinking) {
            addThinking(data.thinking);
          }
          addMessage(data.response, 'assistant');
          
          if (data.sessionId && data.sessionId !== sessionId) {
            sessionId = data.sessionId;
            localStorage.setItem('forge_session', sessionId);
            updateSessionStatus();
          }
        }
      } catch (error) {
        waitEl.remove();
        addMessage(`Error: ${error.message}`, 'assistant', 'error');
      }

      isWaiting = false;
      sendBtn.disabled = false;
      inputEl.focus();
      loadSidebarData();
    }

    async function newChat() {
      sessionId = null;
      localStorage.removeItem('forge_session');
      chatEl.innerHTML = `
        <div class="empty-state">
          <div class="logo">‚öíÔ∏è</div>
          <div>Self-evolving AI agent</div>
          <div class="feature-badges">
            <span class="badge">üß¨ Self-Evolution</span>
            <span class="badge">üß† Thinking</span>
            <span class="badge">üîß Tool Creation</span>
          </div>
        </div>
      `;
      updateSessionStatus();
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      loadSidebarData();
    }

    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.sidebar-tab:nth-child(${tab === 'persona' ? 1 : tab === 'memory' ? 2 : 3})`).classList.add('active');
      document.getElementById(`${tab}-panel`).classList.add('active');
    }

    async function loadSidebarData() {
      // Load persona
      try {
        const res = await fetch('/api/persona', { headers: { 'Authorization': `Bearer ${authToken}` } });
        const persona = await res.json();
        document.getElementById('persona-status').textContent = `Persona v${persona.version}`;
        document.getElementById('persona-info').innerHTML = `
          <div class="item-card">
            <div class="label">Traits</div>
            <div class="trait-list">
              ${persona.traits.map(t => `<span class="trait">${t}</span>`).join('')}
            </div>
          </div>
          <div class="item-card">
            <div class="label">Rules (${persona.rules.length})</div>
            ${persona.rules.length > 0 
              ? persona.rules.map((r, i) => `<div style="margin-top: 0.5rem;">${i + 1}. ${escapeHtml(r)}</div>`).join('')
              : '<div style="color: #666; margin-top: 0.5rem;">No rules defined</div>'}
          </div>
          <div class="item-card">
            <div class="label">Tip</div>
            <div style="color: #888; font-size: 0.85rem;">
              Ask Forge to "add a rule" or "change your personality" to evolve!
            </div>
          </div>
        `;
      } catch {}

      // Load memory
      try {
        const res = await fetch('/api/memory', { headers: { 'Authorization': `Bearer ${authToken}` } });
        const facts = await res.json();
        document.getElementById('memory-list').innerHTML = facts.length === 0
          ? '<p style="color: #666;">No memories yet.</p>'
          : facts.map(f => `
            <div class="item-card">
              <span class="delete" onclick="deleteMemory('${f.id}')">&times;</span>
              <div class="label">${f.category}</div>
              ${escapeHtml(f.text)}
            </div>
          `).join('');
      } catch {}

      // Load tools
      try {
        const res = await fetch('/api/tools', { headers: { 'Authorization': `Bearer ${authToken}` } });
        const tools = await res.json();
        document.getElementById('tools-list').innerHTML = tools.length === 0
          ? '<p style="color: #666;">No custom tools. Ask Forge to create one!</p>'
          : tools.map(t => `
            <div class="item-card">
              <div class="label">üîß ${t.name}</div>
              ${escapeHtml(t.description)}
            </div>
          `).join('');
      } catch {}
    }

    async function deleteMemory(id) {
      await fetch(`/api/memory/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
      loadSidebarData();
    }

    function handleKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
    });

    updateSessionStatus();
    loadSidebarData();
    inputEl.focus();
  </script>
</body>
</html>
